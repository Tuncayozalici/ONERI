@model ONERI.Models.GenelFabrikaOzetViewModel
@{
    ViewData["Title"] = "Günlük Veriler Panosu";
}

<link rel="stylesheet" href="~/css/boyahane.css" />

<style>
    .daily-page {
        background: radial-gradient(1200px 350px at 20% -10%, #e8f2ff 0%, rgba(232, 242, 255, 0) 60%),
                    radial-gradient(900px 300px at 85% 0%, #fff2da 0%, rgba(255, 242, 218, 0) 55%);
        padding-bottom: 2.5rem;
    }

    .daily-hero {
        background: #fff;
        border-radius: 22px;
        padding: 1.75rem 2rem;
        border: 1px solid rgba(0, 0, 0, 0.04);
        box-shadow: 0 10px 30px rgba(16, 24, 40, 0.06);
        margin-bottom: 1.5rem;
    }

    .daily-hero h2 {
        font-family: "Poppins", "Inter", system-ui, -apple-system, sans-serif;
        font-weight: 800;
        letter-spacing: -0.4px;
        margin-bottom: 0.35rem;
    }

    .daily-hero .hero-kicker {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        color: #5b6b8c;
        margin-bottom: 0.35rem;
    }

    .summary-card {
        background: #fff;
        border-radius: 18px;
        border: 1px solid rgba(0, 0, 0, 0.04);
        box-shadow: 0 10px 30px rgba(16, 24, 40, 0.06);
    }

    .summary-card .card-header {
        background: transparent;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        font-weight: 600;
    }

    .summary-card .summary-kpis {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
    }

    .summary-card .summary-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
    }

    .summary-card .summary-charts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
    }

    .summary-card .summary-chart-wide {
        grid-column: 1 / -1;
    }

    .summary-card.summary-ultra .summary-kpis {
        grid-template-columns: repeat(6, minmax(0, 1fr));
    }

    .summary-card.summary-ultra .summary-metrics {
        grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    .summary-card.summary-ultra .summary-charts {
        grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    .summary-card.summary-ultra {
        width: 100vw;
        margin-left: calc(50% - 50vw);
        margin-right: calc(50% - 50vw);
        border-radius: 0;
    }

    .nav-tile {
        border-radius: 20px;
        border: 1px solid rgba(0, 0, 0, 0.04);
        box-shadow: 0 10px 30px rgba(16, 24, 40, 0.08);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        padding: 1.5rem 1.25rem;
        background: #fff;
    }

    .nav-tile:hover {
        transform: translateY(-4px);
        box-shadow: 0 14px 36px rgba(16, 24, 40, 0.12);
    }

    .nav-tile .icon {
        width: 64px;
        height: 64px;
        border-radius: 16px;
        display: grid;
        place-items: center;
        margin: 0 auto 0.75rem;
        font-size: 1.6rem;
        background: #f3f5f8;
        color: #2f3a4a;
    }

    .tile-kicker {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.75rem;
        font-weight: 600;
        color: #0d6efd;
        background: rgba(13, 110, 253, 0.08);
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        margin-bottom: 0.4rem;
    }

    .tile-kicker.warn {
        color: #c16d00;
        background: rgba(255, 152, 0, 0.12);
    }

    .tile-kicker.ok {
        color: #146c43;
        background: rgba(20, 108, 67, 0.12);
    }
</style>

<div class="daily-page">
<div class="container">
    <div class="daily-hero">
        <div class="hero-kicker"><i class="bi bi-activity"></i> Günlük Veriler</div>
        <h2>Fabrika Veri Panosu</h2>
        <p class="text-muted mb-0">Tüm bölümlerden gelen günlük üretim ve performans verilerini tek ekranda izleyin.</p>
    </div>

    <div class="row mb-5">
        <div class="col-12">
            <div class="summary-card" id="summaryCard">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <span>Genel Fabrika Özeti</span>
                    <div class="d-flex align-items-center gap-3 flex-wrap">
                        <small class="text-muted">Seçili Aralık: @ViewBag.OzetRange</small>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="summaryUltraToggle">
                            <label class="form-check-label" for="summaryUltraToggle">Ultrawide</label>
                        </div>
                        <form asp-action="GunlukVeriler" method="get" id="summaryFilterForm" class="d-flex align-items-center gap-2">
                            <input type="date" id="summaryDate" name="raporTarihi" class="form-control form-control-sm" />
                            <select id="summaryMonth" name="ay" class="form-select form-select-sm">
                                <option value="">Ay</option>
                                <option value="1">Ocak</option>
                                <option value="2">Şubat</option>
                                <option value="3">Mart</option>
                                <option value="4">Nisan</option>
                                <option value="5">Mayıs</option>
                                <option value="6">Haziran</option>
                                <option value="7">Temmuz</option>
                                <option value="8">Ağustos</option>
                                <option value="9">Eylül</option>
                                <option value="10">Ekim</option>
                                <option value="11">Kasım</option>
                                <option value="12">Aralık</option>
                            </select>
                            <input type="number" id="summaryYear" name="yil" class="form-control form-control-sm" placeholder="Yıl" value="@DateTime.Now.Year" />
                            <button type="submit" class="btn btn-sm btn-primary">Filtrele</button>
                            <button type="button" id="summaryClear" class="btn btn-sm btn-outline-secondary">Temizle</button>
                        </form>
                    </div>
                </div>
                <div class="card-body">
                    <div class="summary-kpis mb-4">
                        <div class="kpi-card h-100">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-graph-up me-2"></i>Toplam Üretim</h6>
                                <p class="card-text">@Model.ToplamUretim.ToString("N0")</p>
                            </div>
                        </div>
                        <div class="kpi-card h-100">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-x-circle me-2"></i>Hatalı Adet</h6>
                                <p class="card-text">@Model.ToplamHataAdet.ToString("N0")</p>
                            </div>
                        </div>
                        <div class="kpi-card h-100">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-square me-2"></i>Hatalı m²</h6>
                                <p class="card-text">@Model.ToplamHataM2.ToString("N2")</p>
                            </div>
                        </div>
                        <div class="kpi-card h-100">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-stopwatch me-2"></i>Duraklama (dk)</h6>
                                <p class="card-text">@Model.ToplamDuraklamaDakika.ToString("N0")</p>
                            </div>
                        </div>
                        <div class="kpi-card h-100">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-speedometer2 me-2"></i>Kullanılabilirlik</h6>
                                <p class="card-text">@Model.OrtalamaKullanilabilirlik.ToString("F2") %</p>
                            </div>
                        </div>
                        <div class="kpi-card h-100">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-activity me-2"></i>Fiili Çalışma</h6>
                                <p class="card-text">@Model.OrtalamaFiiliCalisma.ToString("F2") %</p>
                            </div>
                        </div>
                    </div>

                    <div class="summary-metrics mb-4">
                        <div class="p-3 bg-light rounded-3 h-100">
                            <div class="fw-semibold mb-2">En Çok Hata Nedeni</div>
                            <div class="text-muted">@Model.EnCokHataNedeni</div>
                        </div>
                        <div class="p-3 bg-light rounded-3 h-100">
                            <div class="fw-semibold mb-2">En Çok Hata Bölümü</div>
                            <div class="text-muted">@Model.EnCokHataBolum</div>
                        </div>
                        <div class="p-3 bg-light rounded-3 h-100">
                            <div class="fw-semibold mb-2">En Çok Hata Operatörü</div>
                            <div class="text-muted">@Model.EnCokHataOperator</div>
                        </div>
                    </div>

                    <div class="summary-charts">
                        <div class="card shadow-sm h-100">
                            <div class="card-header">Birleşik Üretim Trendi</div>
                            <div class="card-body">
                                <canvas id="genelUretimTrend"></canvas>
                            </div>
                        </div>
                        <div class="card shadow-sm h-100">
                            <div class="card-header">Hata Trendi</div>
                            <div class="card-body">
                                <canvas id="genelHataTrend"></canvas>
                            </div>
                        </div>
                        <div class="card shadow-sm h-100">
                            <div class="card-header">Bölüm Katkısı (Üretim)</div>
                            <div class="card-body">
                                <canvas id="bolumKatkiGrafigi"></canvas>
                            </div>
                        </div>
                        <div class="card shadow-sm h-100">
                            <div class="card-header">Duraklama Trendi</div>
                            <div class="card-body">
                                <canvas id="duraklamaTrendGrafigi"></canvas>
                            </div>
                        </div>
                        <div class="card shadow-sm h-100">
                            <div class="card-header">Hata Nedenleri (Top 6)</div>
                            <div class="card-body">
                                <div class="chart-pie-wrap">
                                    <canvas id="hataNedenGenelGrafigi" class="chart-pie"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bölüm Navigasyon Kartları -->
    <div class="row g-4">
        <div class="col-lg-3 col-md-6">
            <a href="@Url.Action("ProfilLazerVerileri", "Home")" class="nav-tile">
                <div class="status-dot active"></div>
                <div class="text-center">
                    <div class="icon">
                        <i class="bi bi-speedometer2"></i>
                    </div>
                    <h5>Profil Lazer Bölümü</h5>
                    <p>Günlük üretim, verimlilik ve trend analizleri.</p>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6">
            <a href="@Url.Action("BoyahaneDashboard", "Home")" class="nav-tile">
                <div class="status-dot active"></div>
                <div class="text-center">
                    <div class="icon">
                        <i class="bi bi-paint-bucket"></i>
                    </div>
                    <h5>Boyahane Bölümü</h5>
                    <p>Günlük boyama, fire ve hata analizleri.</p>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6">
            <a href="@Url.Action("PvcDashboard", "Home")" class="nav-tile">
                <div class="status-dot active"></div>
                <div class="text-center">
                    <div class="icon">
                        <i class="bi bi-bounding-box"></i>
                    </div>
                    <h5>PVC Bölümü</h5>
                    <p>Üretim metrajı, duraklama ve verimlilik analizleri.</p>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6">
            <a href="@Url.Action("MasterwoodDashboard", "Home")" class="nav-tile">
                <div class="status-dot active"></div>
                <div class="text-center">
                    <div class="icon">
                        <i class="bi bi-tree"></i>
                    </div>
                    <h5>Masterwood Bölümü</h5>
                    <p>Delik, freeze ve duraklama analizleri.</p>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6">
            <a href="@Url.Action("SkipperDashboard", "Home")" class="nav-tile">
                <div class="status-dot active"></div>
                <div class="text-center">
                    <div class="icon">
                        <i class="bi bi-cpu"></i>
                    </div>
                    <h5>Skipper Bölümü</h5>
                    <p>Delik, duraklama ve oran trendleri.</p>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6">
            <a href="@Url.Action("TezgahDashboard", "Home")" class="nav-tile">
                <div class="status-dot active"></div>
                <div class="text-center">
                    <div class="icon">
                        <i class="bi bi-gear"></i>
                    </div>
                    <h5>Tezgah Bölümü</h5>
                    <p>Parça, kişi, kayıp süre ve kullanılabilirlik.</p>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6">
            <a href="@Url.Action("EbatlamaDashboard", "Home")" class="nav-tile">
                <div class="status-dot active"></div>
                <div class="text-center">
                    <div class="icon">
                        <i class="bi bi-tools"></i>
                    </div>
                    <h5>Ebatlama Bölümü</h5>
                    <p>Kesim, plaka, duraklama ve mesai analizleri.</p>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6">
            <a href="@Url.Action("HataliParcaDashboard", "Home")" class="nav-tile">
                <div class="status-dot active"></div>
                <div class="text-center">
                    <div class="icon">
                        <i class="bi bi-bug"></i>
                    </div>
                    <h5>Hatalı Parça Analizi</h5>
                    <p>Hata nedenleri, bölümler ve operatör trendleri.</p>
                </div>
            </a>
        </div>
    </div>
</div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const summaryCard = document.getElementById('summaryCard');
            const summaryToggle = document.getElementById('summaryUltraToggle');
            if (summaryCard && summaryToggle) {
                const saved = localStorage.getItem('summary_ultra');
                const enabled = saved === '1';
                summaryCard.classList.toggle('summary-ultra', enabled);
                summaryToggle.checked = enabled;
                summaryToggle.addEventListener('change', function() {
                    summaryCard.classList.toggle('summary-ultra', summaryToggle.checked);
                    localStorage.setItem('summary_ultra', summaryToggle.checked ? '1' : '0');
                });
            }

            const summaryDate = document.getElementById('summaryDate');
            const summaryMonth = document.getElementById('summaryMonth');
            const summaryYear = document.getElementById('summaryYear');
            const summaryClear = document.getElementById('summaryClear');
            const summaryForm = document.getElementById('summaryFilterForm');

            function toggleSummaryFilters() {
                if (summaryMonth.value) {
                    summaryDate.disabled = true;
                    summaryDate.value = '';
                } else {
                    summaryDate.disabled = false;
                }

                if (summaryDate.value) {
                    summaryMonth.disabled = true;
                    summaryYear.disabled = true;
                    summaryMonth.value = '';
                    summaryYear.value = '@DateTime.Now.Year';
                } else {
                    summaryMonth.disabled = false;
                    summaryYear.disabled = false;
                }
            }

            if (summaryDate) {
                const urlParams = new URLSearchParams(window.location.search);
                const raporTarihi = urlParams.get('raporTarihi');
                const ay = urlParams.get('ay');
                const yil = urlParams.get('yil');
                const resolvedYear = @Html.Raw(ViewBag.OzetResolvedYear ?? "null");

                if (raporTarihi) {
                    summaryDate.value = raporTarihi;
                } else if (ay && yil) {
                    summaryMonth.value = ay;
                    summaryYear.value = resolvedYear ?? yil;
                    summaryDate.value = '';
                }
            }

            toggleSummaryFilters();

            summaryMonth.addEventListener('change', toggleSummaryFilters);
            summaryDate.addEventListener('input', toggleSummaryFilters);

            if (summaryForm) {
                summaryForm.addEventListener('submit', function() {
                    if (summaryMonth.value) {
                        summaryDate.value = '';
                        summaryDate.disabled = true;
                    }
                });
            }

            summaryClear.addEventListener('click', function() {
                summaryMonth.value = '';
                summaryYear.value = '@DateTime.Now.Year';
                summaryDate.value = '';
                toggleSummaryFilters();
                window.location.href = '/Home/GunlukVeriler';
            });

            new Chart(document.getElementById('genelUretimTrend').getContext('2d'), {
                type: 'line',
                data: {
                    labels: @Html.Raw(Json.Serialize(Model.TrendLabels)),
                    datasets: [{
                        label: 'Toplam Üretim',
                        data: @Html.Raw(Json.Serialize(Model.UretimTrendData)),
                        borderColor: 'rgba(54, 162, 235, 0.9)',
                        backgroundColor: 'rgba(54, 162, 235, 0.15)',
                        tension: 0.2,
                        fill: true
                    }]
                },
                options: { responsive: true }
            });

            new Chart(document.getElementById('genelHataTrend').getContext('2d'), {
                type: 'line',
                data: {
                    labels: @Html.Raw(Json.Serialize(Model.TrendLabels)),
                    datasets: [{
                        label: 'Hatalı Adet',
                        data: @Html.Raw(Json.Serialize(Model.HataTrendData)),
                        borderColor: 'rgba(255, 99, 132, 0.9)',
                        backgroundColor: 'rgba(255, 99, 132, 0.15)',
                        tension: 0.2,
                        fill: true
                    }]
                },
                options: { responsive: true }
            });

            new Chart(document.getElementById('bolumKatkiGrafigi').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: @Html.Raw(Json.Serialize(Model.BolumUretimLabels)),
                    datasets: [{
                        label: 'Üretim',
                        data: @Html.Raw(Json.Serialize(Model.BolumUretimData)),
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 0.9)',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true }
            });

            new Chart(document.getElementById('hataNedenGenelGrafigi').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: @Html.Raw(Json.Serialize(Model.HataNedenLabels)),
                    datasets: [{
                        data: @Html.Raw(Json.Serialize(Model.HataNedenData)),
                        backgroundColor: ['#ff6384', '#36a2eb', '#ffcd56', '#4bc0c0', '#9966ff', '#ff9f40']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            new Chart(document.getElementById('duraklamaTrendGrafigi').getContext('2d'), {
                type: 'line',
                data: {
                    labels: @Html.Raw(Json.Serialize(Model.TrendLabels)),
                    datasets: [{
                        label: 'Duraklama (dk)',
                        data: @Html.Raw(Json.Serialize(Model.DuraklamaTrendData)),
                        borderColor: 'rgba(153, 102, 255, 0.9)',
                        backgroundColor: 'rgba(153, 102, 255, 0.12)',
                        tension: 0.2,
                        fill: true
                    }]
                },
                options: { responsive: true }
            });
        });
    </script>
}
